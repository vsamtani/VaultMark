<!DOCTYPE html>
<html>
  <!-- Load cpdf. We only use this for getting the version number. Everything else is done by the cpdfworker.js -->
  <!-- <script src="dist/coherentpdf.browser.js"></script> -->

  <!-- The full browser-based script -->




  <!-- Script for downloading the resultant file -->
  <script>
    function filedownload(data, filename, mime, bom) {
    var blobData = (typeof bom !== 'undefined') ? [bom, data] : [data]
    var blob = new Blob(blobData, {type: mime || 'application/octet-stream'});
    if (typeof window.navigator.msSaveBlob !== 'undefined') {
        window.navigator.msSaveBlob(blob, filename);
    }
    else {
        var blobURL = (window.URL && window.URL.createObjectURL) ? window.URL.createObjectURL(blob) : window.webkitURL.createObjectURL(blob);
        var tempLink = document.createElement('a');
        tempLink.style.display = 'none';
        tempLink.href = blobURL;
        tempLink.setAttribute('download', filename);

        if (typeof tempLink.download === 'undefined') {
            tempLink.setAttribute('target', '_blank');
        }

        document.body.appendChild(tempLink);
        tempLink.click();

        setTimeout(function() {
            document.body.removeChild(tempLink);
            window.URL.revokeObjectURL(blobURL);
        }, 200)
    }
}
  </script>

  <!-- The page itself -->
  <body>
    <h1>coherentpdf.js example</h1>
    <p>Choose a PDF file, and this web page will use a web worker to rotate the file 10 degrees, and then prompt you to download it.</p>
    <p>This happens entirely within the browser.</p>
    <p id="demo"></p>
    <input type="file" id="file-selector">
    <p><i><b id="progress">Choose a file to begin...</b></i></p>
    <h3>PDF Information</h3>
    <p>Pages: <b id="pages"></b></p>
    <p>Creator: <b id="creator"></b></p>
    <p>Producer: <b id="producer"></b></p>
  </body>

  <!-- Machinery for the file upload process -->
  <script>
    var lib = function() {};
  </script>
  <script>
    const fileSelector = document.getElementById('file-selector');
    fileSelector.addEventListener('change', (event) => {
      const fileList = event.target.files;
      const reader = new FileReader();
      reader.addEventListener('load', (event) => {
        const result = event.target.result;
        // Do something with result
        lib.foo = result;
        });
      reader.readAsArrayBuffer(fileList[0]);
    });
  </script>
  <!-- Main script. Start the worker and process messages from it. -->
  <script>
  
  function ensureFooIsSet(timeout) {
  var start = Date.now();
  return new Promise(waitForFoo);

  function waitForFoo(resolve, reject) {
      if (window.lib && window.lib.foo)
          resolve(window.lib.foo);
      else if (timeout && (Date.now() - start) >= timeout)
          reject(new Error("timeout"));
      else
          setTimeout(waitForFoo.bind(this, resolve, reject), 30);
  }
}

    // document.getElementById("demo").innerHTML = 'coherentpdf.js, loaded version: ' + coherentpdf.version();


    // create a function to be the worker, complete with the entire coherentpdf-browser script





    function workerFunction() {

    // importScripts('cpdf/coherentpdf.browser.js');   
      
      
      
      
      var self=this;
      self.onmessage = function(e) {
       
        switch (e.data.mtype)
        {
          case 'location':
            importScripts(e.data.url + '/cpdf/coherentpdf.browser.js');
          case 'pdf':
            //Load the PDF from the array of bytes handed to us by index.html
            var pdf = coherentpdf.fromMemory(e.data.bytes, "");
            coherentpdf.setFast();
            self.postMessage({mtype: 'progress', message: '(1/4) PDF loaded successfully from file ...'});
            //Send some metadata back to index.html
            self.postMessage({mtype: 'pages', x: coherentpdf.pages(pdf)});
            self.postMessage({mtype: 'creator', x: coherentpdf.getCreator(pdf)});
            self.postMessage({mtype: 'producer', x: coherentpdf.getProducer(pdf)});
            //If the PDF is encrypted with blank owner password, decrypt it.
            coherentpdf.decryptPdf(pdf, "");
            self.postMessage({mtype: 'progress', message: '(2/4) File decrypted if necessary...'});
            //Rotate the contents of each page by 10 degrees
            //coherentpdf.rotateContents(pdf, coherentpdf.all(pdf), 10);
            //self.postMessage({mtype: 'progress', message: '(3/4) File rotated....'});
            //Seal the file and write to memory
            var permissions = [coherentpdf.noAnnot, coherentpdf.noAssemble, coherentpdf.noEdit, coherentpdf.noExtract, coherentpdf.noForms];
            var encryption = coherentpdf.aes256bitisotrue;
            let ownerPassword = "";
            while (ownerPassword.length < 30) {
              ownerPassword += Math.random().toString(36).slice(2,7);
            };
            console.log(ownerPassword);
            var mem = coherentpdf.toMemoryEncrypted(pdf, encryption, permissions, ownerPassword, "", false, false);
            self.postMessage({mtype: 'progress', message: '(4/4) File encrypted to memory....'});
            //Write the result to a PDF file as an array of bytes
            //var mem = coherentpdf.toMemory(pdf, false, false);
            //self.postMessage({mtype: 'progress', message: '(4/4) File serialized to memory...'});
            //Send the file back to index.html
            self.postMessage({mtype: 'pdfout', bytes: mem});
            //This worker will be terminated by index.html, so no need to call coherentpdf.deletePdf
            break;
        }
      }
    }

    var dataObj = '(' + workerFunction + ')();'; // here is the trick to convert the above fucntion to string
    var blob = new Blob([dataObj.replace('"use strict";', '')]); // firefox adds "use strict"; to any function which might block worker execution so knock it off

    var blobURL = (window.URL ? URL : webkitURL).createObjectURL(blob, {
      type: 'application/javascript; charset=utf-8'
    });
    ensureFooIsSet(100000).then(function(){
  document.getElementById("progress").innerHTML = '(0/4) PDF File loaded from disc. Processing...';
  var arr = new Uint8Array(lib.foo);
  // var w = new Worker("cpdfworker.js");
  var w = new Worker(blobURL);
  // tell the blob worker our location so it can import scripts
  w.postMessage({mtype: 'location', url: document.location.origin + document.location.pathname});
  // give the blob worker the pdf 
  w.postMessage({mtype: 'pdf', bytes: arr});
  w.onmessage = function(e)
  {
    switch (e.data.mtype)
    {
      case 'pdfout':
        filedownload(e.data.bytes, "download.pdf");
        document.getElementById("progress").innerHTML += "<br>" + 'Processing finished. Output PDF file downloaded. Reload page to do another file.';
        w.terminate();
        break;
      case 'progress':
        document.getElementById("progress").innerHTML += "<br>" + e.data.message ;
        break;
      case 'pages':
        document.getElementById("pages").innerHTML = e.data.x;
        break;
      case 'creator':
        document.getElementById("creator").innerHTML = e.data.x;
        break;
      case 'producer':
        document.getElementById("producer").innerHTML = e.data.x;
        break;
    }
  }
});
  </script>
</html>
